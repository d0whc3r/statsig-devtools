name: 'CI - Main Branch'

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      run-e2e-tests:
        description: 'Run E2E tests'
        required: false
        default: true
        type: boolean
      create-release:
        description: 'Create release artifacts'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '22'

permissions:
  contents: write # Required for semantic-release to create releases and push commits
  issues: write # Required for semantic-release to comment on issues
  pull-requests: write # Required for semantic-release to comment on PRs

jobs:
  # Setup and dependency installation
  setup:
    name: 'Setup & Dependencies'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

  # Quality checks (lint, format, type-check)
  quality-checks:
    name: 'Quality Checks'
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run quality checks
        uses: ./.github/actions/quality-checks

  # Unit tests with coverage
  unit-tests:
    name: 'Unit Tests'
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run tests
        uses: ./.github/actions/run-tests
        with:
          run-unit-tests: 'true'
          run-e2e-tests: 'false'
          upload-coverage: 'true'

  # Build extensions
  build:
    name: 'Build Extensions'
    runs-on: ubuntu-latest
    needs: [quality-checks, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build extensions
        uses: ./.github/actions/build-extensions
        with:
          build-chrome: 'true'
          build-firefox: 'true'
          upload-artifacts: 'true'

  # E2E tests (disabled - requires complex CI setup with Xvfb, etc.)
  # TODO: Enable when proper headless browser setup is configured
  # e2e-tests:
  #   name: 'E2E Tests'
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: |
  #     github.event_name == 'workflow_dispatch' &&
  #     github.event.inputs.run-e2e-tests == 'true'
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js and dependencies
  #       uses: ./.github/actions/setup-node-deps
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #
  #     - name: Run E2E tests
  #       uses: ./.github/actions/run-tests
  #       with:
  #         run-unit-tests: 'false'
  #         run-e2e-tests: 'true'

  # Semantic Release - Version bump and release
  semantic-release:
    name: 'Semantic Release'
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      always() &&
      needs.build.result == 'success' &&
      github.event_name == 'push'
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new-release-published }}
      new-release-version: ${{ steps.semantic.outputs.new-release-version }}
      new-release-tag: ${{ steps.semantic.outputs.new-release-git-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build extensions for release
        uses: ./.github/actions/build-extensions
        with:
          build-chrome: 'true'
          build-firefox: 'true'
          upload-artifacts: 'false'

      - name: Create release packages
        uses: ./.github/actions/create-release-artifacts
        with:
          create-chrome-zip: 'true'
          create-firefox-zip: 'true'

      - name: Run Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Running semantic release..."
          npx semantic-release
          echo "‚úÖ Semantic release completed"

  # Auto-publish to stores after successful release
  auto-publish-to-stores:
    name: 'Auto-Publish to Stores'
    runs-on: ubuntu-latest
    needs: [semantic-release]
    if: |
      always() &&
      needs.semantic-release.result == 'success' &&
      needs.semantic-release.outputs.new-release-published == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.semantic-release.outputs.new-release-tag }}

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build extensions for store submission
        uses: ./.github/actions/build-extensions
        with:
          build-chrome: 'true'
          build-firefox: 'true'
          upload-artifacts: 'false'

      - name: Create release packages
        uses: ./.github/actions/create-release-artifacts
        with:
          create-chrome-zip: 'true'
          create-firefox-zip: 'true'
          version: ${{ needs.semantic-release.outputs.new-release-version }}

      - name: Publish to extension stores
        uses: ./.github/actions/publish-to-stores
        with:
          publish-chrome: 'true'
          publish-firefox: 'true'
          dry-run: 'false'
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
          CHROME_PUBLISH_TARGET: ${{ secrets.CHROME_PUBLISH_TARGET || 'default' }}
          CHROME_SKIP_SUBMIT_REVIEW: ${{ secrets.CHROME_SKIP_SUBMIT_REVIEW || 'false' }}
          FIREFOX_EXTENSION_ID: ${{ secrets.FIREFOX_EXTENSION_ID }}
          FIREFOX_JWT_ISSUER: ${{ secrets.FIREFOX_JWT_ISSUER }}
          FIREFOX_JWT_SECRET: ${{ secrets.FIREFOX_JWT_SECRET }}
          FIREFOX_CHANNEL: ${{ secrets.FIREFOX_CHANNEL || 'listed' }}

      - name: Update release with store publication status
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = '${{ needs.semantic-release.outputs.new-release-tag }}';

            // Get the release by tag
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag
            });

            // Add store publication status to release body
            const storeStatus = `

            ## üöÄ Automatic Store Publication

            This release has been automatically published to extension stores:

            - ‚úÖ **Chrome Web Store**: [Install Extension](https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }})
            - ‚úÖ **Firefox Add-ons**: [Install Extension](https://addons.mozilla.org/addon/${{ secrets.FIREFOX_EXTENSION_ID }})

            *Published automatically via GitHub Actions on ${new Date().toISOString()}*
            `;

            // Update release body
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body: release.body + storeStatus
            });

            console.log('‚úÖ Release updated with store publication status');

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // Create deployment
            const { data: deployment } = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref: '${{ needs.semantic-release.outputs.new-release-tag }}',
              environment: 'production',
              description: 'Automatic extension store publication',
              auto_merge: false,
              required_contexts: []
            });

            // Create deployment status
            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: deployment.id,
              state: 'success',
              description: 'Successfully published to Chrome Web Store and Firefox Add-ons',
              environment: 'production'
            });

            console.log('‚úÖ Deployment record created');

  # Manual release artifacts (for workflow_dispatch)
  manual-release-artifacts:
    name: 'Manual Release Artifacts'
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      always() &&
      needs.build.result == 'success' &&
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.create-release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build extensions for release
        uses: ./.github/actions/build-extensions
        with:
          build-chrome: 'true'
          build-firefox: 'true'
          upload-artifacts: 'false'

      - name: Create release packages
        uses: ./.github/actions/create-release-artifacts
        with:
          create-chrome-zip: 'true'
          create-firefox-zip: 'true'

  # Security scan (optional)
  security-scan:
    name: 'Security Scan'
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit
        run: |
          echo "üîí Running security audit..."
          npm audit --audit-level=moderate
          echo "‚úÖ Security audit completed"

  # Final status check
  ci-success:
    name: 'CI Success'
    runs-on: ubuntu-latest
    needs: [quality-checks, unit-tests, build, semantic-release, manual-release-artifacts, auto-publish-to-stores]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "üìä Job Results Summary:"
          echo "  - Quality Checks: ${{ needs.quality-checks.result }}"
          echo "  - Unit Tests: ${{ needs.unit-tests.result }}"
          echo "  - Build: ${{ needs.build.result }}"
          echo "  - Semantic Release: ${{ needs.semantic-release.result }}"
          echo "  - Manual Release: ${{ needs.manual-release-artifacts.result }}"
          echo "  - Auto-Publish to Stores: ${{ needs.auto-publish-to-stores.result }}"

          # Check critical jobs
          if [ "${{ needs.quality-checks.result }}" != "success" ] ||
             [ "${{ needs.unit-tests.result }}" != "success" ] ||
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Critical CI jobs failed"
            exit 1
          fi

          # Show release and publication info
          if [ "${{ needs.semantic-release.outputs.new-release-published }}" == "true" ]; then
            echo "üéâ New release published: v${{ needs.semantic-release.outputs.new-release-version }}"
            
            if [ "${{ needs.auto-publish-to-stores.result }}" == "success" ]; then
              echo "üöÄ Extension automatically published to stores!"
              echo "  ‚úÖ Chrome Web Store: Published"
              echo "  ‚úÖ Firefox Add-ons: Published"
            else
              echo "‚ö†Ô∏è Release created but store publication failed"
            fi
          else
            echo "‚ÑπÔ∏è No new release (no qualifying commits)"
          fi

          echo "‚úÖ All CI jobs completed successfully"
