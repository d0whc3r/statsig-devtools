---
inclusion: always
---

# Project Structure Steering Document

## Architecture Overview

Statsig DevTools is a browser extension built with WXT framework, React 19, and TypeScript. The architecture follows a modular, component-based design with clear separation between extension contexts, UI components, business logic, and utilities.

## Directory Organization

### Root Level

```
statsig-devtools/
├── entrypoints/          # WXT entry points (extension contexts)
├── src/                  # Application source code
├── public/               # Static assets (icons, manifest resources)
├── e2e/                  # End-to-end tests with Playwright
├── coverage/             # Test coverage reports
├── .kiro/               # Project documentation and specifications
├── .output/             # Build output (generated by WXT)
└── config files         # TypeScript, ESLint, Prettier, WXT, etc.
```

### Extension Entry Points (`entrypoints/`)

WXT automatically detects and builds entry points based on file structure:

```
entrypoints/
├── background.ts         # Service worker (API coordination, tab monitoring)
├── content.ts           # Content script (page injection, storage manipulation)
├── popup/               # Extension popup interface (480x550px)
│   ├── App.tsx          # Popup root component
│   ├── main.tsx         # React entry point
│   ├── index.html       # HTML template
│   └── style.css        # Popup-specific styles
├── sidepanel/           # Chrome sidebar interface
│   ├── App.tsx          # Sidebar root component
│   ├── main.tsx         # React entry point
│   ├── index.html       # HTML template
│   └── style.css        # Sidebar-specific styles
├── tab/                 # Full-screen tab interface
│   ├── App.tsx          # Tab root component
│   ├── main.tsx         # React entry point
│   ├── index.html       # HTML template
│   └── style.css        # Tab-specific styles
├── modules/             # Shared extension modules
│   ├── storage-operations.ts  # Browser storage manipulation
│   ├── statsig-injection.ts   # Statsig API interception
│   └── script-execution.ts    # Page script injection utilities
└── types/               # Extension-specific type definitions
    └── content-types.ts # Content script message types
```

### Application Source (`src/`)

```
src/
├── components/          # React UI components
│   ├── AppLayout.tsx    # Universal layout wrapper for all view modes
│   ├── Dashboard.tsx    # Main dashboard orchestrator
│   ├── AuthComponent.tsx # Authentication flow
│   ├── ViewModeToggle.tsx # View mode switching component
│   ├── PopupInfoBar.tsx # Compact statistics bar
│   ├── auth/            # Authentication components (modular)
│   │   ├── ApiKeyInput.tsx
│   │   ├── AuthForm.tsx
│   │   ├── AuthHeader.tsx
│   │   ├── AuthSubmitButton.tsx
│   │   ├── ErrorAlert.tsx
│   │   └── index.ts     # Barrel export
│   ├── configuration-list/ # Configuration management (modular)
│   │   ├── ConfigurationItem.tsx
│   │   ├── ConfigurationSearchAndFilters.tsx
│   │   ├── ConfigurationLoadingState.tsx
│   │   ├── ConfigurationErrorState.tsx
│   │   ├── ConfigurationEmptyState.tsx
│   │   ├── useConfigurationFilters.ts
│   │   ├── useConfigurationOverrides.ts
│   │   ├── index.ts     # Barrel export
│   │   └── README.md    # Component documentation
│   ├── notification-system/ # Notification system (modular)
│   │   ├── NotificationItem.tsx
│   │   ├── NotificationContainer.tsx
│   │   ├── NotificationIcon.tsx
│   │   ├── NotificationActions.tsx
│   │   ├── useNotificationManager.ts
│   │   ├── useNotifications.ts
│   │   ├── useNotificationStyles.ts
│   │   ├── types.ts
│   │   ├── index.ts     # Barrel export
│   │   └── README.md    # Component documentation
│   ├── override-manager/ # Override management (modular)
│   │   ├── OverrideItem.tsx
│   │   ├── OverrideList.tsx
│   │   ├── OverrideHeader.tsx
│   │   ├── OverrideEmptyState.tsx
│   │   ├── ConfirmationDialog.tsx
│   │   ├── useOverrideManager.ts
│   │   ├── types.ts
│   │   ├── utils.ts
│   │   ├── index.ts     # Barrel export
│   │   └── README.md    # Component documentation
│   ├── ViewModeToggle/  # View mode toggle (modular)
│   │   ├── DebugButton.tsx
│   │   ├── ErrorDisplay.tsx
│   │   ├── LoadingSpinner.tsx
│   │   ├── ReadOnlyTooltip.tsx
│   │   ├── ToggleButton.tsx
│   │   ├── ToggleIcon.tsx
│   │   ├── ToggleText.tsx
│   │   ├── UnsupportedMessage.tsx
│   │   └── index.ts     # Barrel export
│   └── [Other components...] # Additional UI components
├── hooks/               # Custom React hooks
│   ├── useAuth.ts       # Authentication state management
│   ├── useActiveTab.ts  # Active tab information
│   ├── useConfigurationData.ts # Configuration data fetching
│   ├── useConfigurationEvaluation.ts # Configuration evaluation
│   ├── useStorageOverrides.ts # Storage override management
│   ├── useViewModeToggle.ts # View mode switching logic
│   └── [Other hooks...] # Additional custom hooks
├── services/            # Business logic layer
│   ├── unified-statsig-api.ts # Main Statsig API service
│   ├── statsig-api.ts   # Console API client
│   ├── storage-manager.ts # Encrypted browser storage
│   ├── error-handler.ts # Centralized error management
│   ├── cache-manager.ts # Configuration caching
│   ├── view-mode.ts     # View mode service
│   ├── storage-injection.ts # Storage injection service
│   └── [Other services...] # Additional business services
├── utils/               # Utility functions
│   ├── browser-api.ts   # Browser API abstractions
│   ├── logger.ts        # Development logging
│   ├── configuration-formatters.ts # Data formatting
│   ├── viewModeToggleConfig.ts # View mode configuration
│   └── index.ts         # Utility exports
├── types/               # TypeScript type definitions
│   └── index.ts         # Global type definitions
├── styles/              # Global CSS styles
│   └── globals.css      # Tailwind CSS imports
├── test/                # Test setup and utilities
│   └── setup.ts         # Vitest configuration
└── integration/         # Integration tests
    └── configuration-processing.test.ts
```

## Architectural Patterns

### 1. Multi-Context Extension Architecture

The extension operates in multiple browser contexts:

- **Background Script**: Service worker handling API calls, tab monitoring, and inter-context communication
- **Content Script**: Injected into web pages for storage manipulation and Statsig interception
- **Popup**: Compact 480x550px interface for quick operations
- **Sidebar**: Read-only comprehensive view in Chrome's side panel
- **Tab**: Full-screen interface for complex operations

### 2. Universal Layout Pattern

All view modes share the same `AppLayout` component:

```tsx
// Each entry point uses the same layout with different view modes
<AppLayout viewMode="popup" />    // entrypoints/popup/App.tsx
<AppLayout viewMode="sidebar" />  // entrypoints/sidepanel/App.tsx
<AppLayout viewMode="tab" />      // entrypoints/tab/App.tsx
```

### 3. Modular Component Architecture

Large components are broken down into focused, reusable modules:

```
ComponentName/
├── index.ts              # Barrel export
├── ComponentName.tsx     # Main orchestrator (30-50 lines)
├── SubComponent1.tsx     # Focused sub-components
├── SubComponent2.tsx     # Single responsibility each
├── useComponentLogic.ts  # Custom hook for business logic
├── types.ts             # Component-specific types
├── utils.ts             # Component-specific utilities
└── README.md            # Component documentation
```

### 4. Service Layer Pattern

Services follow a consistent pattern:

- **Singleton Pattern**: Single instance per service
- **Async/Await**: Promise-based APIs throughout
- **Error Handling**: Centralized error management
- **Dependency Injection**: Services accept dependencies as parameters

### 5. Hook-Based State Management

State management uses React hooks pattern:

- **Local State**: `useState` for component-specific state
- **Custom Hooks**: Encapsulate complex state logic
- **No Global State**: Prop drilling with context for shared data
- **Browser Storage**: Persistent state using `browser.storage.local`

## File Naming Conventions

- **Components**: PascalCase (e.g., `ConfigurationList.tsx`)
- **Hooks**: camelCase with `use` prefix (e.g., `useAuth.ts`)
- **Services**: kebab-case (e.g., `storage-manager.ts`)
- **Types**: camelCase (e.g., `index.ts`)
- **Tests**: Same as source with `.test.ts` suffix
- **Entry Points**: WXT convention (e.g., `background.ts`, `content.ts`)

## Import/Export Patterns

### Import Organization (ESLint Enforced)

```typescript
// 1. External packages first
import React from 'react'
import { StatsigClient } from '@statsig/js-client'

// 2. Internal packages with @/ alias
import { logger } from '@/src/utils/logger'
import { errorHandler } from '@/src/services/error-handler'

// 3. Relative imports
import { ButtonConfig } from './types'
import { getButtonConfig } from '../utils/config'

// 4. Type imports (separated automatically)
import type { ViewMode } from '../services/view-mode'
import type { AuthState } from '../types'
```

### Export Patterns

- **Default Exports**: Components and main service classes
- **Named Exports**: Utilities, types, and helper functions
- **Barrel Exports**: Index files for clean imports
- **Absolute Imports**: Use `@/` alias for src directory

### Barrel Export Pattern

```typescript
// src/components/ViewModeToggle/index.ts
export { DebugButton } from './DebugButton'
export { ErrorDisplay } from './ErrorDisplay'
export { LoadingSpinner } from './LoadingSpinner'
export { ToggleButton } from './ToggleButton'
// ... other exports
```

## Component Organization Principles

### 1. Single Responsibility Principle

Each component has one clear purpose:

- `ConfigurationItem` handles individual configuration rendering
- `NotificationIcon` handles icon rendering logic
- `OverrideHeader` manages expansion state and bulk actions

### 2. Composition over Inheritance

Complex components are built from simple ones:

- `Dashboard` composes `DashboardHeader`, `DashboardContent`, `OverrideManager`
- `AppLayout` composes `AuthComponent`, `Dashboard`, `ViewModeToggle`

### 3. Co-located Organization

Related files are kept together:

- Components with their tests, types, and utilities
- Feature-specific hooks within component directories
- README documentation for complex modules

### 4. Progressive Enhancement

Components support different complexity levels:

- Basic functionality in main component
- Enhanced features in sub-components
- Advanced logic in custom hooks

## State Management Architecture

### 1. Local State First

```typescript
// Component-specific state
const [isLoading, setIsLoading] = useState(false)
const [error, setError] = useState<string | null>(null)
```

### 2. Custom Hooks for Complex Logic

```typescript
// Extract complex logic into reusable hooks
export function useViewModeToggle(currentMode: ViewMode) {
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState(null)
  // ... business logic
  return { isLoading, error, handleToggle, handleDebugTest }
}
```

### 3. Service Layer for Persistence

```typescript
// Services handle persistent state
export class StorageManager {
  async storeConsoleApiKey(apiKey: string): Promise<void>
  async getConsoleApiKey(): Promise<string | null>
  // ... other methods
}
```

## API Communication Patterns

### 1. Unified Service Interface

```typescript
// Single service interface for all Statsig operations
export class UnifiedStatsigService {
  async validateApiKey(apiKey: string): Promise<ApiValidationResponse>
  async getAllConfigurations(): Promise<StatsigConfigurationItem[]>
  async evaluateFeatureGate(gateName: string): Promise<EvaluationResult>
}
```

### 2. Dual API Strategy

- **Console API**: Server-side key for configuration metadata
- **Client SDK**: Client-side key for real-time evaluation
- **Validation**: Different validation logic for each key type

### 3. Error Handling Pattern

```typescript
// Centralized error handling with categorization
try {
  await riskyOperation()
} catch (error) {
  const statsigError = errorHandler.handleError(error, 'Operation context')
  showUserError(statsigError.userMessage)
}
```

## Extension Communication Architecture

### 1. Message Passing Pattern

```typescript
// Structured communication between contexts
interface ContentScriptMessage {
  type: 'SET_STORAGE_OVERRIDE' | 'REMOVE_STORAGE_OVERRIDE' | 'PING'
  payload?: unknown
}

interface ContentScriptResponse {
  success: boolean
  error?: string
  data?: unknown
}
```

### 2. Background Script Coordination

- API calls and caching
- Tab monitoring and validation
- Inter-context message routing
- Extension lifecycle management

### 3. Content Script Injection

- Storage manipulation on target pages
- Statsig API interception
- Script execution utilities
- Cross-origin communication

## Testing Architecture

### 1. Unit Testing (Vitest)

- Component testing with React Testing Library
- Hook testing with custom test utilities
- Service testing with mocked dependencies
- Utility function testing

### 2. Integration Testing

- API integration tests
- Storage operation tests
- Extension communication tests
- Cross-browser compatibility tests

### 3. End-to-End Testing (Playwright)

- Extension loading and initialization
- User workflow testing
- Cross-browser extension testing
- Performance and reliability testing

## Build and Development Architecture

### 1. WXT Framework Integration

- Automatic entry point detection
- Cross-browser manifest generation
- Hot reload for development
- Optimized production builds

### 2. Development Environment

- TypeScript strict mode
- ESLint with comprehensive rules
- Prettier for code formatting
- Husky for git hooks

### 3. Quality Assurance

- 90% test coverage requirement
- Automated linting and formatting
- Type checking on every build
- Pre-commit quality gates

## Asset Management

- **Icons**: Multiple sizes (16, 32, 48, 96, 128px) in `public/icon/`
- **Static Files**: Public directory for manifest resources
- **Generated Assets**: Build output in `.output/` directory
- **Development Assets**: Hot reload and dev server assets
- **Test Assets**: Coverage reports and test artifacts
